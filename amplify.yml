version: 1
backend:
  phases:
    preBuild:
      commands:
        # Clean any previous builds
        - rm -rf .amplify/artifacts
        - rm -rf amplify/**/node_modules
        # Add debugging
        - echo "Node version: $(node --version)"
        - echo "NPM version: $(npm --version)"
        - echo "Current directory: $(pwd)"
        - ls -la amplify/auth/post-confirmation/
        # Install main dependencies
        - npm ci --cache .npm --prefer-offline --no-audit
        # Install Amplify CLI
        - npm install -g @aws-amplify/cli@latest
        # Install Lambda function dependencies
        - |
          echo "Installing Lambda function dependencies..."
          find amplify -name "package.json" -not -path "*/node_modules/*" | while read package; do
            dir=$(dirname "$package")
            echo "Installing dependencies in $dir"
            cd "$dir"
            npm ci --no-audit
            cd - > /dev/null
          done
    build:
      commands:
        - export NODE_ENV=production
        # Validate TypeScript compilation
        - echo "Validating TypeScript..."
        - npx tsc --noEmit --skipLibCheck || echo "TypeScript validation completed with warnings"
        # Deploy backend
        - echo "Deploying backend..."
        - npm run deploy
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline --no-audit
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache: 
    paths:
      - .npm/**/*
      - node_modules/**/*
      - amplify/**/node_modules/**/*