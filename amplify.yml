version: 1
backend:
  phases:
    preBuild:
      commands:
        # Install main dependencies
        - npm install --cache .npm --prefer-offline --no-audit
        # Install Amplify Gen 2 CLI
        - npm install -g @aws-amplify/backend-cli@latest
        # Install Lambda function dependencies
        - |
          echo "Installing Lambda function dependencies..."
          find amplify -name "package.json" -not -path "*/node_modules/*" | while read package; do
            dir=$(dirname "$package")
            echo "Installing dependencies in $dir"
            cd "$dir"
            if [ -f "package.json" ] && grep -q '"dependencies"' package.json; then
              npm install --no-audit
            fi
            cd - > /dev/null
          done
    build:
      commands:
        - export NODE_ENV=production
        # TypeScript compilation check
        - echo "Checking TypeScript compilation..."
        - npx tsc --noEmit --skipLibCheck || echo "TypeScript check completed with warnings"
        # Deploy backend directly
        - echo "Deploying backend..."
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID --outputs-out-dir ./amplify_outputs --outputs-format json
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline --no-audit
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache: 
    paths:
      - .npm/**/*
      - node_modules/**/*
      - amplify/**/node_modules/**/*